// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Country {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  requiresVat Boolean  @default(false) @map("requires_vat")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@map("countries")
}

enum UserRole {
  ADMIN
  MANAGER
  TECHNICIAN
  VIEWER
}

model Store {
  id           String   @id @default(uuid())
  name         String
  address      String?
  street       String?
  city         String?
  state        String?
  postalCode   String?  @map("postal_code")
  country      String?
  logo         String?
  website      String?
  phone        String?
  email        String?
  currency     String?  @default("USD")
  vatNumber    String?  @map("vat_number")
  taxEnabled   Boolean  @default(false) @map("tax_enabled")
  taxRate      Decimal? @map("tax_rate") @db.Decimal(5, 2)
  taxInclusive Boolean  @default(false) @map("tax_inclusive")
  onboarded    Boolean  @default(false)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  users            User[]
  userInvitations  UserInvitation[]
  customers        Customer[]
  repairTickets    RepairTicket[]
  settings         Settings?
  inventoryItems   InventoryItem[]

  @@map("stores")
}

model User {
  id                         String    @id @default(uuid())
  email                      String    @unique
  passwordHash               String    @map("password_hash")
  name                       String?
  profileImage               String?   @map("profile_image")
  storeId                    String    @map("store_id")
  role                       UserRole  @default(VIEWER) @map("role")
  invitedBy                  String?   @map("invited_by")
  invitedAt                  DateTime? @map("invited_at")
  isActive                   Boolean   @default(true) @map("is_active")
  emailVerified              Boolean   @default(false) @map("email_verified")
  verificationToken          String?   @map("verification_token")
  verificationTokenExpiry    DateTime? @map("verification_token_expiry")
  lastVerificationEmailSent  DateTime? @map("last_verification_email_sent")
  createdAt                  DateTime  @default(now()) @map("created_at")
  updatedAt                  DateTime  @updatedAt @map("updated_at")

  store       Store            @relation(fields: [storeId], references: [id], onDelete: Restrict)
  sessions    Session[]
  accounts    Account[]
  inviter     User?            @relation("UserInvitations", fields: [invitedBy], references: [id])
  invitees    User[]           @relation("UserInvitations")
  invitations UserInvitation[] @relation("Inviter")

  @@index([storeId])
  @@index([storeId, role])
  @@index([isActive])
  @@index([verificationToken])
  @@map("users")
}

model Settings {
  id             String   @id @default(uuid())
  storeId        String   @unique @map("store_id")
  primaryColor   String   @default("#FFD700") @map("primary_color")
  secondaryColor String   @default("#000000") @map("secondary_color")
  language       String?  @default("en") @map("language")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@map("settings")
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String
  storeId   String   @map("store_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store         Store          @relation(fields: [storeId], references: [id], onDelete: Restrict)
  repairTickets RepairTicket[]

  @@unique([storeId, email])
  @@index([storeId])
  @@map("customers")
}

model RepairTicket {
  id                      String    @id @default(uuid())
  ticketNumber            String    @unique @map("ticket_number")
  customerId              String    @map("customer_id")
  storeId                 String    @map("store_id")
  deviceType              String    @map("device_type")
  deviceBrand             String?   @map("device_brand")
  deviceModel             String?   @map("device_model")
  deviceSerialNumber      String?   @map("device_serial_number")
  issueDescription        String    @map("issue_description") @db.Text
  status                  String    @default("pending")
  priority                String    @default("medium")
  estimatedCost           Decimal?  @map("estimated_cost") @db.Decimal(10, 2)
  actualCost              Decimal?  @map("actual_cost") @db.Decimal(10, 2)
  estimatedCompletionDate DateTime? @map("estimated_completion_date") @db.Date
  actualCompletionDate    DateTime? @map("actual_completion_date") @db.Date
  notes                   String?   @db.Text
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  store        Store         @relation(fields: [storeId], references: [id], onDelete: Restrict)
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Restrict)
  ticketImages TicketImage[]
  expenses     Expense[]

  @@index([customerId])
  @@index([storeId])
  @@index([status])
  @@index([priority])
  @@index([createdAt(sort: Desc)])
  @@index([ticketNumber])
  @@map("repair_tickets")
}

model TicketImage {
  id        String   @id @default(uuid())
  ticketId  String   @map("ticket_id")
  fileName  String   @map("file_name")
  filePath  String   @map("file_path")
  fileSize  Int?     @map("file_size")
  mimeType  String?  @map("mime_type")
  createdAt DateTime @default(now()) @map("created_at")

  ticket RepairTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("ticket_images")
}

model Expense {
  id             String   @id @default(uuid())
  ticketId       String   @map("ticket_id")
  inventoryItemId String? @map("inventory_item_id")
  name           String
  quantity       Decimal  @db.Decimal(10, 2)
  price          Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  ticket        RepairTicket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([inventoryItemId])
  @@map("expenses")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("sessions")
}

model Account {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refreshToken      String?  @map("refresh_token") @db.Text
  accessToken       String?  @map("access_token") @db.Text
  expiresAt         Int?     @map("expires_at")
  tokenType         String?  @map("token_type")
  scope             String?  @db.Text
  idToken           String?  @map("id_token") @db.Text
  sessionState      String?  @map("session_state") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model InventoryItem {
  id             String   @id @default(uuid())
  storeId        String   @map("store_id")
  name           String
  sku            String?  @map("sku")
  description    String?  @db.Text
  category       String?
  location       String?
  currentQuantity Decimal  @default(0) @map("current_quantity") @db.Decimal(10, 2)
  minQuantity    Decimal  @default(0) @map("min_quantity") @db.Decimal(10, 2)
  unitPrice      Decimal? @map("unit_price") @db.Decimal(10, 2)
  costPrice      Decimal? @map("cost_price") @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Restrict)
  expenses Expense[]

  @@unique([storeId, sku])
  @@index([storeId])
  @@index([category])
  @@index([sku])
  @@index([currentQuantity])
  @@map("inventory_items")
}

model UserInvitation {
  id         String    @id @default(uuid())
  email      String
  storeId    String    @map("store_id")
  role       UserRole
  invitedBy  String    @map("invited_by")
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  store   Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  inviter User  @relation("Inviter", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@unique([storeId, email])
  @@index([token])
  @@index([expiresAt])
  @@map("user_invitations")
}
